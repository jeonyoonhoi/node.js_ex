{"version":3,"sources":["../src/upgrader.js"],"names":["require","Spinner","chalk","inquirer","powershell","utils","strings","versions","findNpm","debug","regeneratorRuntime","Upgrader","program","options","prompt","spinner","dnsCheck","checkInternetConnection","isOnline","exit","noInternet","executionPolicyCheck","checkExecutionPolicy","isExecutable","noExecutionPolicy","executionPolicyCheckError","getInstalledNPMVersion","installedVersion","npmVersion","getAvailableNPMVersions","availableVersions","versionList","type","name","message","choices","reverse","then","answer","version","getLatestNPMVersion","npmPath","npmPaths","log","path","startingUpgradeSimple","console","start","runSimpleUpgrade","output","stop","error","startingUpgradeComplex","runUpgrade","stdout","includes","noAdmin","upgradeComplex","wasUpgradeSuccessful","isDone","upgradeFinished","upgradeSimple","logUpgradeFailure","catch","err","quiet","errors","getVersions","debugVersions","info","red","bold","length","process","i","setTimeout","module","exports"],"mappings":"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","file":"upgrader.js","sourcesContent":["const { Spinner } = require('cli-spinner')\nconst chalk = require('chalk')\nconst inquirer = require('inquirer')\n\nconst powershell = require('./powershell')\nconst utils = require('./utils')\nconst strings = require('./strings')\nconst versions = require('./versions')\nconst findNpm = require('./find-npm')\nconst debug = require('./debug')\n\n// eslint-disable-next-line no-use-before-define\nconst regeneratorRuntime = regeneratorRuntime || require('regenerator-runtime-only')\n\nclass Upgrader {\n  constructor (program) {\n    this.options = program\n\n    if (this.options.prompt === false) {\n      this.options.spinner = false\n    }\n  }\n\n  /**\n   * Executes the upgrader's \"let's check the user's internet\" logic,\n   * eventually quietly resolving or quitting the process with an\n   * error if the connection is not sufficient\n   */\n  async ensureInternet () {\n    if (this.options.dnsCheck !== false) {\n      const isOnline = await utils.checkInternetConnection()\n\n      if (!isOnline) {\n        utils.exit(1, strings.noInternet)\n      }\n    }\n  }\n\n  /**\n   * Executes the upgrader's \"let's check the user's powershell execution\n   * policy\" logic, eventually quietly resolving or quitting the process\n   * with an error if the policy is not sufficient\n   */\n  async ensureExecutionPolicy () {\n    if (this.options.executionPolicyCheck !== false) {\n      try {\n        const isExecutable = await utils.checkExecutionPolicy()\n\n        if (!isExecutable) {\n          utils.exit(1, strings.noExecutionPolicy)\n        }\n      } catch (err) {\n        utils.exit(1, strings.executionPolicyCheckError, err)\n      }\n    }\n  }\n\n  /**\n   * Checks if the upgrade was successful\n   *\n   * @return {boolean} - was the upgrade successful?\n   */\n  async wasUpgradeSuccessful () {\n    this.installedVersion = await versions.getInstalledNPMVersion()\n    return (this.installedVersion === this.options.npmVersion)\n  }\n\n  /**\n   * Executes the upgrader's \"let's have the user choose a version\" logic\n   */\n  async chooseVersion () {\n    if (!this.options.npmVersion) {\n      const availableVersions = await versions.getAvailableNPMVersions()\n      const versionList = [{\n        type: 'list',\n        name: 'version',\n        message: 'Which version do you want to install?',\n        choices: availableVersions.reverse()\n      }]\n\n      this.options.npmVersion = await inquirer.prompt(versionList)\n        .then(answer => answer.version)\n    }\n\n    if (this.options.npmVersion === 'latest') {\n      this.options.npmVersion = await versions.getLatestNPMVersion()\n    }\n  }\n\n  /**\n   * Executes the upgrader's \"let's find npm\" logic\n   */\n  async choosePath () {\n    try {\n      const npmPaths = await findNpm(this.options.npmPath)\n\n      this.log(npmPaths.message)\n      this.options.npmPath = npmPaths.path\n\n      debug(`Upgrader: Chosen npm path: ${this.options.npmPath}`)\n    } catch (err) {\n      utils.exit(1, err)\n    }\n  }\n\n  /**\n   * Attempts a simple upgrade, eventually calling npm install -g npm\n   *\n   * @param {string} version - Version that should be installed\n   * @private\n   */\n  async upgradeSimple () {\n    this.spinner = new Spinner(`${strings.startingUpgradeSimple} %s`)\n\n    if (this.options.spinner === false) {\n      console.log(strings.startingUpgradeSimple)\n    } else {\n      this.spinner.start()\n    }\n\n    const output = await powershell.runSimpleUpgrade(this.options.npmVersion)\n\n    this.spinner.stop(false)\n    console.log('\\n')\n\n    if (output.error) {\n      throw output.error\n    }\n  }\n\n  /**\n   * Upgrades npm in the correct directory, securing and reapplying\n   * existing configuration\n   *\n   * @param  {string} version - Version that should be installed\n   * @param  {string} npmPath - Path where npm should be installed\n   * @private\n   */\n  async upgradeComplex () {\n    this.spinner = new Spinner(`${strings.startingUpgradeComplex} %s`)\n\n    if (this.options.spinner === false) {\n      console.log(strings.startingUpgradeComplex)\n    } else {\n      this.spinner.start()\n    }\n\n    const output = await powershell.runUpgrade(this.options.npmVersion, this.options.npmPath)\n\n    this.spinner.stop(false)\n    console.log('\\n')\n\n    // If we failed to elevate to administrative rights, we have to abort.\n    if (output.stdout[0] && output.stdout[0].includes('NOTADMIN')) {\n      utils.exit(1, strings.noAdmin)\n    }\n  }\n\n  /**\n   * Executes the full upgrade flow\n   */\n  upgrade () {\n    debug('Starting upgrade')\n\n    return this.upgradeComplex()\n      .then(() => this.wasUpgradeSuccessful())\n      .then((isDone) => {\n        if (isDone) {\n          // Awesome, the upgrade worked!\n          utils.exit(0, strings.upgradeFinished(this.installedVersion))\n        } else {\n          return this.upgradeSimple()\n        }\n      })\n      .then(() => this.wasUpgradeSuccessful())\n      .then((isDone) => {\n        if (isDone) {\n          // Awesome, the upgrade worked!\n          utils.exit(0, strings.upgradeFinished(this.installedVersion))\n        } else {\n          this.logUpgradeFailure()\n        }\n      })\n      .catch((err) => console.log(err))\n  }\n\n  /**\n   * Logs a message to console, unless the user specified quiet mode\n   *\n   * @param {string} message - message to log\n   * @private\n   */\n  log (message) {\n    if (!this.options.quiet) {\n      console.log(message)\n    }\n  }\n\n  /**\n   * If the whole upgrade failed, we use this method to log a\n   * detailed trace with versions - all to make it easier for\n   * users to create meaningful issues.\n   *\n   * @param errors {array} - AS many errors as found\n   */\n  logUpgradeFailure (...errors) {\n    // Uh-oh, something didn't work as it should have.\n    versions.getVersions().then((debugVersions) => {\n      let info\n\n      if (this.options.npmVersion && this.installedVersion) {\n        info = `You wanted to install npm ${this.options.npmVersion}, but the installed version is ${this.installedVersion}.\\n\\n`\n        info += 'A common reason is an attempted \"npm install npm\" or \"npm upgrade npm\". '\n        info += 'As of today, the only solution is to completely uninstall and then reinstall Node.js. '\n        info += 'For a small tutorial, please see https://github.com/felixrieseberg/npm-windows-upgrade#usage.\\n'\n      } else if (this.options.npmVersion) {\n        info = `You wanted to install npm ${this.options.npmVersion}, but we could not confirm that the installation succeeded.`\n      } else {\n        info = 'We encountered an error during installation.\\n'\n      }\n\n      info += '\\nPlease consider reporting your trouble to https://aka.ms/npm-issues.'\n\n      console.log(chalk.red(info))\n      console.log(chalk.bold('\\nDebug Information:\\n'))\n      console.log(debugVersions)\n\n      if (errors && errors.length && errors.length > 0) console.log('Here is the error:')\n\n      // If we just got an error string (we shouldn't handle that)\n      if (typeof errors !== 'string') {\n        console.log('\\n' + errors + '\\n')\n        return process.exit(1)\n      }\n\n      for (let i = 0; i < errors.length; i++) {\n        console.log('\\n' + errors[i] + '\\n')\n      }\n\n      setTimeout(() => {\n        process.exit(1)\n      }, 1000)\n    })\n  }\n}\n\nmodule.exports = Upgrader\n"]}